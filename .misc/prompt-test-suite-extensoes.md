# Prompt para Cria√ß√£o de Test Suite Completa para Extens√µes de Navegador

## üß™ MISS√ÉO: CRIAR SUITE COMPLETA DE TESTES PARA BROWSER EXTENSION

Voc√™ √© um **Senior Browser Extension Test Engineer** especializado em **testing de Manifest V3** e **automa√ß√£o cross-browser**. Crie uma **suite completa de testes** para esta extens√£o de navegador, cobrindo todos os aspectos cr√≠ticos do ecossistema de extens√µes com foco em **qualidade**, **seguran√ßa** e **compatibilidade**.

---

## üéØ INSTRU√á√ïES INICIAIS OBRIGAT√ìRIAS

**ANTES DE CRIAR OS TESTES:**
1. **SEMPRE leia o arquivo `agents.md`** - Cont√©m especifica√ß√µes do projeto atual
2. **Analise `manifest.json` completamente** - Define toda a arquitetura de testes
3. **Mapeie todos os componentes** - Content scripts, background, popup, options
4. **Identifique APIs utilizadas** - Determina mocks e stubs necess√°rios
5. **Valide permissions** - Define cen√°rios de teste de seguran√ßa
6. **Determine navegadores alvo** - Chrome, Firefox, Edge ou todos

---

## üìã ESCOPO COMPLETO DE TESTING PARA EXTENS√ïES

### üß™ **TIPOS DE TESTE OBRIGAT√ìRIOS**

#### ÔøΩÔøΩÔøΩÔøΩ **UNIT TESTS** (Prioridade M√°xima)
- **Background Service Worker** - L√≥gica de neg√≥cio isolada
- **Content Scripts** - Fun√ß√µes de manipula√ß√£o DOM
- **Popup Components** - Intera√ß√µes de UI
- **Options Page** - Configura√ß√µes e valida√ß√µes
- **Message Handlers** - Comunica√ß√£o entre contexts
- **Storage Operations** - Persist√™ncia de dados
- **API Wrappers** - Abstra√ß√µes de chrome.* APIs
- **Utility Functions** - Helpers e formatters

#### üîó **INTEGRATION TESTS** (Alta Prioridade)
- **Message Passing** - Comunica√ß√£o content ‚Üî background ‚Üî popup
- **Storage Sync** - Sincroniza√ß√£o entre contexts
- **API Interactions** - Integra√ß√£o com chrome.* APIs
- **Permission Flows** - Solicita√ß√£o e valida√ß√£o de permissions
- **Cross-Context State** - Estado compartilhado entre componentes
- **Event Listeners** - Resposta a eventos do navegador
- **External APIs** - Integra√ß√£o com servi√ßos externos

#### üåê **E2E TESTS** (M√©dia Prioridade)
- **User Workflows** - Fluxos completos de usu√°rio
- **Installation/Update** - Processo de instala√ß√£o e atualiza√ß√£o
- **Cross-Browser** - Funcionalidade em diferentes navegadores
- **Real Website Testing** - Content scripts em sites reais
- **Performance Impact** - Impacto na performance de p√°ginas
- **Error Recovery** - Recupera√ß√£o de erros e estados inv√°lidos

#### üõ°ÔøΩÔøΩÔøΩ **SECURITY TESTS** (Prioridade M√°xima)
- **CSP Compliance** - Viola√ß√µes de Content Security Policy
- **XSS Prevention** - Preven√ß√£o de Cross-Site Scripting
- **Message Validation** - Valida√ß√£o de origem e conte√∫do
- **Permission Abuse** - Uso inadequado de permissions
- **Data Sanitization** - Sanitiza√ß√£o de inputs
- **Storage Security** - Seguran√ßa de dados armazenados

#### ‚ö° **PERFORMANCE TESTS** (Alta Prioridade)
- **Content Script Injection** - Tempo de inje√ß√£o < 5ms
- **Memory Usage** - Vazamentos e uso excessivo
- **Bundle Size** - Tamanho otimizado de arquivos
- **API Response Time** - Lat√™ncia de chamadas
- **Background Processing** - Efici√™ncia de processamento
- **Storage I/O** - Performance de opera√ß√µes de storage

#### üéØ **ACCESSIBILITY TESTS** (M√©dia Prioridade)
- **Keyboard Navigation** - Navega√ß√£o sem mouse
- **Screen Reader** - Compatibilidade com leitores de tela
- **Color Contrast** - Visibilidade para deficientes visuais
- **Focus Management** - Ordem l√≥gica de foco
- **ARIA Compliance** - Atributos de acessibilidade

---

## üèóÔ∏è ESTRUTURA DA SUITE DE TESTES

### **üìÅ Organiza√ß√£o de Arquivos**
```
tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ background/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ service-worker.test.js
‚îÇ   ‚îÇ   ÔøΩÔøΩ‚îÄ‚îÄ message-handlers.test.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api-wrappers.test.js
‚îÇ   ‚îú‚îÄ‚îÄ content/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ content-script.test.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dom-manipulation.test.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page-interaction.test.js
‚îÇ   ‚îú‚îÄ‚îÄ popup/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ popup-ui.test.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ popup-logic.test.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ popup-storage.test.js
‚îÇ   ‚îî‚îÄ‚îÄ shared/
‚îÇ       ‚îú‚îÄ‚îÄ utils.test.js
‚îÇ       ‚îú‚îÄ‚îÄ storage.test.js
‚îÇ       ‚îî‚îÄ‚îÄ messaging.test.js
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ message-passing.test.js
‚îÇ   ‚îú‚îÄ‚îÄ storage-sync.test.js
‚îÇ   ‚îú‚îÄ‚îÄ api-integration.test.js
‚îÇ   ‚îî‚îÄ‚îÄ cross-context.test.js
‚îú‚îÄ‚îÄ e2e/
‚îÇ   ‚îú‚îÄ‚îÄ user-workflows.test.js
‚îÇ   ‚îú‚îÄ‚îÄ installation.test.js
‚îÇ   ‚îú‚îÄ‚îÄ cross-browser.test.js
‚îÇ   ‚îî‚îÄ‚îÄ real-sites.test.js
‚îú‚îÄ‚îÄ security/
‚îÇ   ‚îú‚îÄ‚îÄ csp-compliance.test.js
‚îÇ   ‚îú‚îÄ‚îÄ xss-prevention.test.js
‚îÇ   ‚îú‚îÄ‚îÄ message-validation.test.js
‚îÇ   ‚îî‚îÄ‚îÄ permission-abuse.test.js
‚îú‚îÄ‚îÄ performance/
‚îÇ   ‚îú‚îÄ‚îÄ injection-speed.test.js
‚îÇ   ‚îú‚îÄ‚îÄ memory-usage.test.js
‚îÇ   ‚îú‚îÄ‚îÄ bundle-size.test.js
‚îÇ   ‚îî‚îÄ‚îÄ api-latency.test.js
‚îú‚îÄ‚îÄ accessibility/
‚îÇ   ‚îú‚îÄ‚îÄ keyboard-navigation.test.js
‚îÇ   ‚îú‚îÄ‚îÄ screen-reader.test.js
‚îÇ   ‚îî‚îÄ‚îÄ aria-compliance.test.js
‚îú‚îÄ‚îÄ fixtures/
‚îÇ   ‚îú‚îÄ‚îÄ mock-websites/
‚îÇ   ‚îú‚îÄ‚îÄ test-data/
‚îÇ   ‚îî‚îÄ‚îÄ sample-responses/
‚îú‚îÄ‚îÄ helpers/
‚îÇ   ‚îú‚îÄ‚îÄ extension-loader.js
‚îÇ   ‚îú‚îÄ‚îÄ browser-setup.js
‚îÇ   ‚îú‚îÄ‚îÄ mock-apis.js
‚îÇ   ‚îî‚îÄ‚îÄ test-utils.js
‚îî‚îÄ‚îÄ config/
    ‚îú‚îÄ‚îÄ jest.config.js
    ‚îú‚îÄ‚îÄ puppeteer.config.js
    ‚îú‚îÄ‚îÄ webdriver.config.js
    ‚îî‚îÄ‚îÄ test-environments.js
```

---

## üîß FERRAMENTAS E FRAMEWORKS ESPEC√çFICOS

### **üß™ Testing Frameworks**
```javascript
// Jest para unit e integration tests
const jestConfig = {
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/tests/helpers/setup.js'],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1'
  },
  collectCoverageFrom: [
    'src/**/*.js',
    '!src/vendor/**',
    '!src/**/*.min.js'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  }
};

// Puppeteer para E2E tests
const puppeteerConfig = {
  headless: false,
  devtools: true,
  args: [
    '--disable-extensions-except=./dist',
    '--load-extension=./dist',
    '--disable-web-security'
  ]
};

// WebDriver para cross-browser testing
const webdriverConfig = {
  chrome: {
    options: {
      args: ['--load-extension=./dist']
    }
  },
  firefox: {
    options: {
      prefs: {
        'xpinstall.signatures.required': false
      }
    }
  }
};
```

### **üé≠ Mocking e Stubbing**
```javascript
// Chrome APIs Mock
const chromeMock = {
  runtime: {
    sendMessage: jest.fn(),
    onMessage: {
      addListener: jest.fn(),
      removeListener: jest.fn()
    },
    getURL: jest.fn(path => `chrome-extension://test/${path}`)
  },
  storage: {
    sync: {
      get: jest.fn(),
      set: jest.fn(),
      remove: jest.fn()
    },
    local: {
      get: jest.fn(),
      set: jest.fn(),
      remove: jest.fn()
    }
  },
  tabs: {
    query: jest.fn(),
    sendMessage: jest.fn(),
    create: jest.fn()
  }
};

// DOM Environment Mock
const domMock = {
  document: {
    createElement: jest.fn(),
    getElementById: jest.fn(),
    querySelector: jest.fn(),
    addEventListener: jest.fn()
  },
  window: {
    location: { href: 'https://example.com' },
    addEventListener: jest.fn()
  }
};
```

---

## üìã FORMATO DE SA√çDA OBRIGAT√ìRIO: SUITE COMPLETA

### **OBJETIVO:** Gerar uma estrutura completa de testes organizados em arquivos espec√≠ficos, prontos para execu√ß√£o.

### **ESTRUTURA DE CADA ARQUIVO DE TESTE:**

```javascript
// Exemplo: tests/unit/background/service-worker.test.js

/**
 * @fileoverview Unit tests for Background Service Worker
 * @author Test Engineer
 * @version 1.0.0
 */

import { jest } from '@jest/globals';
import { setupChromeMocks } from '../../helpers/chrome-mocks.js';
import { ServiceWorker } from '../../../src/background/service-worker.js';

describe('Background Service Worker', () => {
  let serviceWorker;
  let chromeMocks;

  beforeEach(() => {
    // Setup
    chromeMocks = setupChromeMocks();
    serviceWorker = new ServiceWorker();
    
    // Reset all mocks
    jest.clearAllMocks();
  });

  afterEach(() => {
    // Cleanup
    serviceWorker.cleanup();
    chromeMocks.restore();
  });

  describe('Initialization', () => {
    test('should initialize with default configuration', () => {
      expect(serviceWorker.isInitialized).toBe(true);
      expect(serviceWorker.config).toMatchObject({
        version: expect.any(String),
        permissions: expect.any(Array)
      });
    });

    test('should register message listeners on init', () => {
      expect(chrome.runtime.onMessage.addListener)
        .toHaveBeenCalledWith(expect.any(Function));
    });

    test('should handle initialization errors gracefully', () => {
      const consoleSpy = jest.spyOn(console, 'error').mockImplementation();
      
      // Force initialization error
      chrome.runtime.onMessage.addListener.mockImplementation(() => {
        throw new Error('Mock initialization error');
      });

      expect(() => new ServiceWorker()).not.toThrow();
      expect(consoleSpy).toHaveBeenCalledWith(
        expect.stringContaining('initialization error')
      );
      
      consoleSpy.mockRestore();
    });
  });

  describe('Message Handling', () => {
    test('should handle valid messages correctly', async () => {
      const mockMessage = {
        action: 'getData',
        payload: { id: 'test123' }
      };
      const mockSender = {
        tab: { id: 1 },
        origin: 'https://example.com'
      };
      const mockSendResponse = jest.fn();

      await serviceWorker.handleMessage(mockMessage, mockSender, mockSendResponse);

      expect(mockSendResponse).toHaveBeenCalledWith({
        success: true,
        data: expect.any(Object)
      });
    });

    test('should reject messages from unauthorized origins', async () => {
      const mockMessage = { action: 'getData' };
      const mockSender = {
        tab: { id: 1 },
        origin: 'https://malicious-site.com'
      };
      const mockSendResponse = jest.fn();

      await serviceWorker.handleMessage(mockMessage, mockSender, mockSendResponse);

      expect(mockSendResponse).toHaveBeenCalledWith({
        success: false,
        error: 'Unauthorized origin'
      });
    });

    test('should validate message structure', async () => {
      const invalidMessage = { invalidField: 'test' };
      const mockSender = { tab: { id: 1 }, origin: 'https://example.com' };
      const mockSendResponse = jest.fn();

      await serviceWorker.handleMessage(invalidMessage, mockSender, mockSendResponse);

      expect(mockSendResponse).toHaveBeenCalledWith({
        success: false,
        error: 'Invalid message structure'
      });
    });
  });

  describe('Storage Operations', () => {
    test('should save data to storage correctly', async () => {
      const testData = { key: 'value', timestamp: Date.now() };
      
      chrome.storage.local.set.mockResolvedValue();

      await serviceWorker.saveData('testKey', testData);

      expect(chrome.storage.local.set).toHaveBeenCalledWith({
        testKey: testData
      });
    });

    test('should handle storage errors gracefully', async () => {
      const testData = { key: 'value' };
      const storageError = new Error('Storage quota exceeded');
      
      chrome.storage.local.set.mockRejectedValue(storageError);

      const result = await serviceWorker.saveData('testKey', testData);

      expect(result.success).toBe(false);
      expect(result.error).toContain('Storage quota exceeded');
    });
  });

  describe('Performance', () => {
    test('should initialize within performance threshold', () => {
      const startTime = performance.now();
      new ServiceWorker();
      const endTime = performance.now();
      
      expect(endTime - startTime).toBeLessThan(100); // < 100ms
    });

    test('should handle concurrent messages efficiently', async () => {
      const messages = Array.from({ length: 10 }, (_, i) => ({
        action: 'getData',
        payload: { id: `test${i}` }
      }));
      
      const startTime = performance.now();
      
      const promises = messages.map(msg => 
        serviceWorker.handleMessage(msg, { tab: { id: 1 }, origin: 'https://example.com' }, jest.fn())
      );
      
      await Promise.all(promises);
      
      const endTime = performance.now();
      expect(endTime - startTime).toBeLessThan(500); // < 500ms for 10 messages
    });
  });

  describe('Error Handling', () => {
    test('should handle API errors gracefully', async () => {
      chrome.tabs.query.mockRejectedValue(new Error('API Error'));

      const result = await serviceWorker.getActiveTab();

      expect(result.success).toBe(false);
      expect(result.error).toContain('API Error');
    });

    test('should log errors appropriately', () => {
      const consoleSpy = jest.spyOn(console, 'error').mockImplementation();
      
      serviceWorker.logError('Test error', { context: 'test' });

      expect(consoleSpy).toHaveBeenCalledWith(
        '[ServiceWorker Error]',
        'Test error',
        { context: 'test' }
      );
      
      consoleSpy.mockRestore();
    });
  });
});
```

---

## üß™ TEMPLATES ESPEC√çFICOS POR TIPO DE TESTE

### **üî¨ Unit Test Template**
```javascript
// Template para unit tests
describe('[Component Name]', () => {
  let component;
  let mocks;

  beforeEach(() => {
    // Setup mocks and component
  });

  afterEach(() => {
    // Cleanup
  });

  describe('Core Functionality', () => {
    test('should [specific behavior]', () => {
      // Arrange
      // Act  
      // Assert
    });
  });

  describe('Error Handling', () => {
    test('should handle [error scenario]', () => {
      // Test error scenarios
    });
  });

  describe('Performance', () => {
    test('should meet performance requirements', () => {
      // Performance assertions
    });
  });
});
```

### **üîó Integration Test Template**
```javascript
// Template para integration tests
describe('[Integration Scenario]', () => {
  let extensionContext;

  beforeAll(async () => {
    // Setup extension environment
    extensionContext = await setupExtensionEnvironment();
  });

  afterAll(async () => {
    // Cleanup extension environment
    await cleanupExtensionEnvironment(extensionContext);
  });

  test('should integrate [components] correctly', async () => {
    // Test component integration
  });

  test('should handle cross-context communication', async () => {
    // Test message passing between contexts
  });
});
```

### **üåê E2E Test Template**
```javascript
// Template para E2E tests
describe('[User Workflow]', () => {
  let browser;
  let page;

  beforeAll(async () => {
    browser = await puppeteer.launch(puppeteerConfig);
    page = await browser.newPage();
    await loadExtension(page);
  });

  afterAll(async () => {
    await browser.close();
  });

  test('should complete [user workflow] successfully', async () => {
    // Simulate user interactions
    // Verify expected outcomes
  });
});
```

### **üõ°Ô∏è Security Test Template**
```javascript
// Template para security tests
describe('[Security Aspect]', () => {
  test('should prevent [security vulnerability]', () => {
    // Test security measures
  });

  test('should validate [input/origin/permission]', () => {
    // Test validation logic
  });

  test('should sanitize [user input/external data]', () => {
    // Test sanitization
  });
});
```

---

## üéØ CONFIGURA√á√ïES ESPEC√çFICAS

### **üì¶ Package.json Scripts**
```json
{
  "scripts": {
    "test": "jest",
    "test:unit": "jest tests/unit",
    "test:integration": "jest tests/integration",
    "test:e2e": "jest tests/e2e",
    "test:security": "jest tests/security",
    "test:performance": "jest tests/performance",
    "test:accessibility": "jest tests/accessibility",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:chrome": "jest --testNamePattern='Chrome'",
    "test:firefox": "jest --testNamePattern='Firefox'",
    "test:cross-browser": "npm run test:chrome && npm run test:firefox",
    "test:ci": "jest --ci --coverage --watchAll=false"
  }
}
```

### **‚öôÔ∏è Jest Configuration**
```javascript
// jest.config.js
export default {
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/tests/helpers/setup.js'],
  testMatch: [
    '<rootDir>/tests/**/*.test.js'
  ],
  collectCoverageFrom: [
    'src/**/*.js',
    '!src/vendor/**',
    '!src/**/*.min.js',
    '!src/manifest.json'
  ],
  coverageReporters: ['text', 'lcov', 'html'],
  coverageDirectory: 'coverage',
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  },
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
    '^@tests/(.*)$': '<rootDir>/tests/$1'
  },
  testTimeout: 10000,
  verbose: true
};
```

---

## üöÄ HELPERS E UTILITIES

### **üîß Extension Loader Helper**
```javascript
// tests/helpers/extension-loader.js
export class ExtensionLoader {
  static async loadExtension(browser, extensionPath) {
    // Load extension in browser
  }

  static async setupTestEnvironment() {
    // Setup test environment
  }

  static async cleanupTestEnvironment() {
    // Cleanup test environment
  }
}
```

### **üé≠ Chrome APIs Mock**
```javascript
// tests/helpers/chrome-mocks.js
export function setupChromeMocks() {
  // Setup comprehensive Chrome API mocks
}

export function createMockTab(options = {}) {
  // Create mock tab object
}

export function createMockMessage(action, payload) {
  // Create mock message object
}
```

### **üìä Performance Helpers**
```javascript
// tests/helpers/performance.js
export class PerformanceHelper {
  static measureExecutionTime(fn) {
    // Measure function execution time
  }

  static measureMemoryUsage() {
    // Measure memory usage
  }

  static createPerformanceReport() {
    // Generate performance report
  }
}
```

---

## üìã CHECKLIST DE IMPLEMENTA√á√ÉO

### **üéØ Pr√©-Implementa√ß√£o**
- [ ] **An√°lise Completa**
  - [ ] `manifest.json` analisado
  - [ ] Arquitetura mapeada
  - [ ] APIs identificadas
  - [ ] Permissions auditadas
  - [ ] Navegadores alvo definidos

### **üèóÔ∏è Estrutura Base**
- [ ] **Organiza√ß√£o de Arquivos**
  - [ ] Estrutura de diret√≥rios criada
  - [ ] Templates de teste preparados
  - [ ] Helpers e utilities implementados
  - [ ] Configura√ß√µes definidas

### **üß™ Implementa√ß√£o de Testes**
- [ ] **Unit Tests**
  - [ ] Background service worker
  - [ ] Content scripts
  - [ ] Popup components
  - [ ] Shared utilities
- [ ] **Integration Tests**
  - [ ] Message passing
  - [ ] Storage operations
  - [ ] API integrations
- [ ] **E2E Tests**
  - [ ] User workflows
  - [ ] Cross-browser compatibility
  - [ ] Real website testing
- [ ] **Security Tests**
  - [ ] CSP compliance
  - [ ] XSS prevention
  - [ ] Permission validation
- [ ] **Performance Tests**
  - [ ] Injection speed
  - [ ] Memory usage
  - [ ] Bundle size

### **‚úÖ Valida√ß√£o Final**
- [ ] **Coverage Requirements**
  - [ ] 80%+ code coverage
  - [ ] All critical paths tested
  - [ ] Error scenarios covered
- [ ] **Cross-Browser Testing**
  - [ ] Chrome compatibility
  - [ ] Firefox compatibility
  - [ ] Edge compatibility (se aplic√°vel)
- [ ] **CI/CD Integration**
  - [ ] Automated test execution
  - [ ] Coverage reporting
  - [ ] Performance monitoring

---

## üéØ RESULTADO ESPERADO

### **üì¶ Deliverables**
1. **Suite completa de testes** organizada por tipo e componente
2. **Configura√ß√µes de testing** para diferentes ambientes
3. **Helpers e utilities** para facilitar testing
4. **Scripts de automa√ß√£o** para execu√ß√£o de testes
5. **Documenta√ß√£o** de como executar e manter os testes

### **üìä M√©tricas de Qualidade**
- **Code Coverage:** ‚â• 80% em todas as categorias
- **Test Performance:** Su√≠te completa executa em < 5 minutos
- **Cross-Browser:** 100% dos testes passam em todos navegadores alvo
- **Security Coverage:** Todos os vetores de ataque testados
- **Maintainability:** Testes s√£o f√°ceis de entender e modificar

### **üöÄ Benef√≠cios**
- ‚úÖ **Confian√ßa** na qualidade do c√≥digo
- ‚úÖ **Detec√ß√£o precoce** de bugs e regress√µes
- ‚úÖ **Documenta√ß√£o viva** do comportamento esperado
- ‚úÖ **Facilita refatora√ß√£o** com seguran√ßa
- ‚úÖ **Compliance** com padr√µes de qualidade
- ‚úÖ **Reduz tempo** de debugging e manuten√ß√£o

**A suite de testes deve ser robusta, maint√≠vel e executar rapidamente, fornecendo feedback imediato sobre a qualidade e funcionalidade da extens√£o.**